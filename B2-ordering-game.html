<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Sentence Sequencing</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: #0d0d0d;
      color: white;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    .background {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(201, 169, 97, 0.18) 0%, transparent 40%),
                  radial-gradient(circle at 70% 80%, rgba(201, 169, 97, 0.16) 0%, transparent 38%),
                  radial-gradient(circle at 20% 70%, rgba(201, 169, 97, 0.12) 0%, transparent 45%),
                  radial-gradient(circle at 85% 15%, rgba(201, 169, 97, 0.14) 0%, transparent 35%),
                  #0d0d0d;
      z-index: 0; overflow: hidden;
    }

    .elegant-curves { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .curve-elegant { position: absolute; border-radius: 50%; filter: blur(2px); }

    .curve-elegant-1 {
      width: 500px; height: 900px; top: -300px; right: -150px;
      border: 3px solid rgba(201, 169, 97, 0.35);
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.15) 0%, rgba(201, 169, 97, 0.08) 50%, transparent 100%);
      transform: rotate(25deg); animation: floatElegant 12s ease-in-out infinite;
      box-shadow: inset 0 0 60px rgba(201, 169, 97, 0.1), 0 0 80px rgba(201, 169, 97, 0.15);
    }
    .curve-elegant-2 {
      width: 600px; height: 1100px; bottom: -400px; left: -200px;
      border: 2.5px solid rgba(201, 169, 97, 0.32);
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.12) 0%, rgba(201, 169, 97, 0.06) 40%, transparent 80%);
      transform: rotate(-20deg); animation: floatElegant 15s ease-in-out infinite reverse;
      box-shadow: inset 0 0 50px rgba(201, 169, 97, 0.08), 0 0 70px rgba(201, 169, 97, 0.12);
    }
    .curve-elegant-3 {
      width: 400px; height: 750px; top: 25%; right: -50px;
      border: 2px solid rgba(201, 169, 97, 0.28);
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.10) 0%, rgba(201, 169, 97, 0.05) 50%, transparent 90%);
      transform: rotate(45deg); animation: driftElegant 18s ease-in-out infinite;
    }
    .curve-elegant-4 {
      width: 450px; height: 850px; top: 50%; left: -100px;
      border: 2.5px solid rgba(201, 169, 97, 0.30);
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.11) 0%, transparent 70%);
      transform: rotate(-35deg); animation: pulseElegant 20s ease-in-out infinite;
    }

    @keyframes floatElegant {
      0%, 100% { transform: translateY(0) rotate(var(--base-rotation, 0deg)); opacity: 1; }
      50% { transform: translateY(-30px) rotate(calc(var(--base-rotation, 0deg) + 3deg)); opacity: 0.85; }
    }
    @keyframes driftElegant {
      0%, 100% { transform: translate(0, 0) rotate(45deg); opacity: 1; }
      33% { transform: translate(20px, -25px) rotate(48deg); opacity: 0.9; }
      66% { transform: translate(-10px, -15px) rotate(42deg); opacity: 0.95; }
    }
    @keyframes pulseElegant {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(-35deg); opacity: 1; }
      50% { transform: translate(-15px, 10px) scale(1.05) rotate(-33deg); opacity: 0.9; }
    }
    .curve-elegant-1 { --base-rotation: 25deg; }
    .curve-elegant-2 { --base-rotation: -20deg; }

    body::before {
      content: '';
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.01'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 1;
    }

    .container { max-width: 900px; margin: 0 auto; position: relative; z-index: 2; padding: 0 1rem; }

    .back-btn {
      position: fixed; top: 1.5rem; left: 1.5rem;
      padding: 0.625rem 1.25rem;
      background: rgba(28, 28, 30, 0.9);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(84, 84, 88, 0.3);
      border-radius: 999px; color: #C9A961;
      font-size: 0.75rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
      z-index: 1000; display: flex; align-items: center; gap: 0.5rem;
    }
    .back-btn:hover { background: rgba(28, 28, 30, 1); border-color: rgba(201, 169, 97, 0.5); transform: translateX(-3px); }

    .header { text-align: center; margin-bottom: 2.5rem; padding: 1.5rem 0 1rem; }
    .header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.25rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.04em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .header .subtitle { font-size: 0.8125rem; color: #8e8e93; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; }

    .game-screen { display: none; padding: 1rem; }
    .game-screen.active { display: block; }

    .game-container {
      background: rgba(28, 28, 30, 0.98);
      backdrop-filter: blur(60px) saturate(180%); -webkit-backdrop-filter: blur(60px) saturate(180%);
      border: 1px solid rgba(84, 84, 88, 0.4);
      border-radius: 1.5rem;
      padding: 1.25rem 1rem 1.5rem;
      max-width: 900px; margin: 0 auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.6), 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .game-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.0625rem; font-weight: 600; color: #C9A961;
      text-align: center; margin-bottom: 0.25rem; padding-bottom: 0.625rem;
      border-bottom: 1px solid rgba(84, 84, 88, 0.3);
      text-transform: uppercase; letter-spacing: 0.02em;
    }
    .game-hint {
      text-align: center; font-size: 0.95rem;
      color: #6b7280; margin-bottom: 1rem;
      font-weight: 500;
    }

    /* SENTENCES */
    .sentences-display {
      background: linear-gradient(180deg, rgba(15, 15, 17, 0.6) 0%, rgba(20, 20, 22, 0.5) 100%);
      border-radius: 1rem;
      border: 1px solid rgba(84, 84, 88, 0.25);
      padding: 0.625rem;
      margin-bottom: 1.25rem;
      max-height: 640px;
      overflow-y: auto;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .sentences-grid { display: flex; flex-direction: column; gap: 0.35rem; }

    /* ‚îÄ‚îÄ BASE CARD: light beige (unpositioned) ‚îÄ‚îÄ */
    .sentence-card {
      background: linear-gradient(135deg, #F5F1E8 0%, #EBE6DC 100%);
      border: 2px solid transparent;
      border-radius: 0.75rem;
      padding: 0.375rem 0.75rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; gap: 0.625rem; align-items: center;
      cursor: pointer; position: relative; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    .sentence-card::before {
      content: ''; position: absolute; left: 0; top: 0;
      width: 4px; height: 100%;
      background: linear-gradient(180deg, #D4A574 0%, #C9A961 100%);
      opacity: 0; transition: opacity 0.3s;
    }
    .sentence-card:hover {
      transform: translateX(4px);
      box-shadow: 0 6px 20px rgba(201, 169, 97, 0.2), 0 3px 8px rgba(0, 0, 0, 0.1);
      border-color: rgba(201, 169, 97, 0.25);
    }
    .sentence-card:hover::before { opacity: 0.6; }
    .sentence-card:active { transform: translateX(2px) scale(0.995); }

    /* ‚îÄ‚îÄ STATE: Fixed anchor ‚Äî darker beige ‚îÄ‚îÄ */
    .sentence-card.fixed-sentence {
      background: linear-gradient(135deg, #D1B982 0%, #C4AB72 100%);
      border: 2px solid rgba(201, 169, 97, 0.4);
      cursor: default;
      box-shadow: 0 3px 12px rgba(201, 169, 97, 0.2), 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .sentence-card.fixed-sentence::before { opacity: 1; background: #B89650; }
    .sentence-card.fixed-sentence:hover {
      transform: none;
      box-shadow: 0 3px 12px rgba(201, 169, 97, 0.2), 0 1px 4px rgba(0, 0, 0, 0.1);
      border-color: rgba(201, 169, 97, 0.4);
    }
    .sentence-card.fixed-sentence .sentence-text-display { color: #1c1c1e; font-weight: 700; }

    /* ‚îÄ‚îÄ STATE: Positioned (has number) ‚Äî mid beige ‚îÄ‚îÄ */
    .sentence-card.has-number {
      background: linear-gradient(135deg, #E8DFC8 0%, #DDD4BC 100%);
      border-color: rgba(201, 169, 97, 0.35);
      box-shadow: 0 3px 12px rgba(201, 169, 97, 0.15), 0 1px 4px rgba(0, 0, 0, 0.08);
    }
    .sentence-card.has-number::before { opacity: 0.7; }

    /* ‚îÄ‚îÄ STATE: Duplicate ‚îÄ‚îÄ */
    .sentence-card.duplicate-number {
      background: linear-gradient(135deg, #FEF3E8 0%, #FDECD4 100%) !important;
      border-color: rgba(239, 68, 68, 0.5) !important;
      animation: pulseWarning 1.5s ease-in-out infinite;
    }
    .sentence-card.duplicate-number::before { background: #f59e0b; opacity: 1; }
    @keyframes pulseWarning {
      0%, 100% { border-color: rgba(239, 68, 68, 0.5); }
      50% { border-color: rgba(239, 68, 68, 0.7); }
    }

    /* ‚îÄ‚îÄ STATE: Correct ‚îÄ‚îÄ */
    .sentence-card.correct {
      border-color: #10b981 !important;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
    }
    .sentence-card.correct::before { background: #10b981; opacity: 1; }

    /* ‚îÄ‚îÄ STATE: Incorrect ‚îÄ‚îÄ */
    .sentence-card.incorrect {
      border-color: #ef4444 !important;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
    }
    .sentence-card.incorrect::before { background: #ef4444; opacity: 1; }

    .sentence-card.multi-line { padding: 0.5rem 0.75rem; }

    /* CARD PARTS */
    .sentence-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.6rem; font-weight: 700; color: #7a6530;
      background: rgba(201, 169, 97, 0.2);
      padding: 0.2rem 0.45rem; border-radius: 999px;
      text-align: center; min-width: 32px; flex-shrink: 0;
    }
    .sentence-content { flex: 1; display: flex; gap: 1rem; align-items: center; }
    .sentence-text-display {
      flex: 1; font-family: 'Crimson Text', serif;
      font-size: 0.9rem; line-height: 1.35; color: #1c1c1e; font-weight: 600;
    }
    .linking-word { color: #dc2626; font-weight: 700; padding: 0 0.125rem; }

    .sentence-input { flex-shrink: 0; }
    .sentence-input input {
      width: 42px; padding: 0.35rem; text-align: center;
      font-size: 0.85rem; font-weight: 700;
      border: 1.5px solid rgba(201, 169, 97, 0.4);
      border-radius: 0.5rem; background: #fff; color: #1c1c1e;
      transition: all 0.25s;
    }
    .sentence-input input:focus {
      outline: none; border-color: #C9A961;
      box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.15);
      background: #fffef8; transform: scale(1.06);
    }
    .sentence-input label {
      display: block; font-family: 'Space Grotesk', sans-serif;
      font-size: 0.625rem; font-weight: 700; color: #6b7280;
      margin-bottom: 0.25rem; text-align: center;
      text-transform: uppercase; letter-spacing: 0.05em;
    }

    .fixed-badge {
      display: inline-flex; align-items: center; gap: 0.25rem;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.5625rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: #7a6530; background: rgba(201, 169, 97, 0.2);
      border: 1px solid rgba(201, 169, 97, 0.3);
      border-radius: 999px; padding: 0.175rem 0.5rem;
      flex-shrink: 0; white-space: nowrap;
    }
    .fixed-badge svg { width: 10px; height: 10px; fill: #7a6530; }

    /* ‚îÄ‚îÄ ACTION BAR ‚îÄ‚îÄ */
    .game-actions {
      display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 999px; padding: 0.35rem;
      max-width: fit-content; margin: 0 auto;
    }
    .game-btn {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem; font-weight: 600; letter-spacing: 0.01em;
      padding: 0.5rem 1.125rem; border: none; border-radius: 999px;
      cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex; align-items: center; gap: 0.35rem; white-space: nowrap;
    }
    .game-btn .btn-icon { font-size: 0.85rem; line-height: 1; }

    .btn-submit { background: #C9A961; color: #111; font-weight: 700; box-shadow: 0 2px 10px rgba(201, 169, 97, 0.35); }
    .btn-submit:hover:not(:disabled) { background: #d4b46e; box-shadow: 0 4px 18px rgba(201, 169, 97, 0.5); transform: scale(1.04); }
    .btn-submit:active:not(:disabled) { transform: scale(0.97); }
    .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-retry { background: rgba(255,255,255,0.08); color: #d4d4d8; border: 1px solid rgba(255,255,255,0.1); }
    .btn-retry:hover { background: rgba(255,255,255,0.14); color: #fff; transform: scale(1.04); }

    .btn-new { background: rgba(255,255,255,0.05); color: #8e8e93; border: 1px solid rgba(255,255,255,0.06); }
    .btn-new:hover { background: rgba(255,255,255,0.1); color: #C9A961; transform: scale(1.04); }

    .btn-answers { background: rgba(99,140,255,0.1); color: #7ba4ff; border: 1px solid rgba(99,140,255,0.15); }
    .btn-answers:hover { background: rgba(99,140,255,0.18); color: #a0bfff; transform: scale(1.04); }
    .btn-answers.showing-answers { background: rgba(99,140,255,0.22); color: #fff; border-color: rgba(99,140,255,0.3); }

    /* ANSWER KEY */
    .answer-key-display {
      display: none;
      background: linear-gradient(135deg, rgba(59,130,246,0.12) 0%, rgba(37,99,235,0.08) 100%);
      border: 2px solid rgba(59,130,246,0.4); border-radius: 1.125rem;
      margin-bottom: 1.5rem; overflow: hidden;
    }
    .answer-key-display.show { display: block; animation: slideIn 0.4s ease-out; }
    .answer-key-header {
      background: linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(37,99,235,0.15) 100%);
      padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid rgba(59,130,246,0.3);
    }
    .answer-key-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 700; color: #3b82f6; text-transform: uppercase; letter-spacing: 0.05em; }
    .close-answers {
      background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3);
      color: #3b82f6; font-size: 1.25rem; font-weight: 700;
      width: 32px; height: 32px; border-radius: 0.5rem;
      cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center; padding: 0;
    }
    .close-answers:hover { background: rgba(59,130,246,0.25); transform: scale(1.1); }
    .answer-key-content { padding: 1.25rem; max-height: 400px; overflow-y: auto; }
    .answer-sentence {
      display: flex; gap: 0.875rem; align-items: flex-start;
      padding: 0.75rem 1rem; margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.5); border-radius: 0.75rem;
      border-left: 4px solid #3b82f6;
    }
    .answer-sentence.answer-fixed { background: rgba(201,169,97,0.15); border-left: 4px solid #C9A961; }
    .answer-number {
      font-family: 'Space Grotesk', sans-serif; font-size: 1.125rem; font-weight: 800;
      min-width: 32px; height: 32px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white; border-radius: 0.5rem;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .answer-sentence.answer-fixed .answer-number { background: linear-gradient(135deg, #C9A961 0%, #B89650 100%); color: #1a1a2e; }
    .answer-text { flex: 1; font-family: 'Crimson Text', serif; font-size: 0.95rem; line-height: 1.5; color: #1c1c1e; font-weight: 600; }

    /* RESULTS */
    .results-display {
      display: none;
      background: linear-gradient(135deg, rgba(201,169,97,0.15) 0%, rgba(201,169,97,0.1) 100%);
      border: 2px solid rgba(201,169,97,0.5); border-radius: 1.125rem;
      padding: 1.75rem; margin-bottom: 1.5rem; text-align: center;
    }
    .results-display.show { display: block; animation: slideIn 0.5s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .results-score { font-family: 'Space Grotesk', sans-serif; font-size: 2.75rem; font-weight: 800; color: #C9A961; margin-bottom: 0.625rem; }
    .results-message { font-size: 1.0625rem; color: #f5f5f7; font-weight: 500; }
    .perfect-score { color: #10b981; }

    .sentences-display::-webkit-scrollbar { width: 8px; }
    .sentences-display::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .sentences-display::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #C9A961 0%, #B89650 50%); border-radius: 4px; }

    @media (max-width: 768px) {
      .back-btn { top: 1rem; left: 1rem; padding: 0.5rem 1rem; font-size: 0.65rem; }
      .sentence-card { padding: 0.75rem 0.875rem; flex-direction: column; gap: 0.625rem; align-items: stretch; }
      .sentence-content { flex-direction: column; gap: 0.625rem; width: 100%; }
      .sentence-input { display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end; }
      .sentence-input label { margin-bottom: 0; }
      .game-btn { padding: 0.45rem 0.875rem; font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <div class="background">
    <div class="elegant-curves">
      <div class="curve-elegant curve-elegant-1"></div>
      <div class="curve-elegant curve-elegant-2"></div>
      <div class="curve-elegant curve-elegant-3"></div>
      <div class="curve-elegant curve-elegant-4"></div>
    </div>
  </div>

  <button class="back-btn" onclick="goBack()"><span>‚Üê</span><span>Back</span></button>

  <div class="container">
    <header class="header">
      <h1>INTUITY</h1>
      <p class="subtitle">Sentence Sequencing Challenge</p>
    </header>

    <div class="game-screen active" id="gameScreen">
      <div class="game-container">
        <h2 class="game-title" id="gameTitle"></h2>
        <p class="game-hint">Put the sentences into the correct order. The first sentence of each paragraph is provided </p>

        <div class="sentences-display">
          <div class="sentences-grid" id="sentencesGrid"></div>
        </div>

        <div class="answer-key-display" id="answerKeyDisplay">
          <div class="answer-key-header">
            <span class="answer-key-title">‚úì Correct Sequence</span>
            <button class="close-answers" onclick="toggleAnswers()">‚úï</button>
          </div>
          <div class="answer-key-content" id="answerKeyContent"></div>
        </div>

        <div class="results-display" id="resultsDisplay">
          <div class="results-score" id="resultsScore">0%</div>
          <div class="results-message" id="resultsMessage">Keep trying!</div>
        </div>

        <div class="game-actions">
          <button class="game-btn btn-submit" id="submitBtn" onclick="checkAnswer()"><span class="btn-icon">‚úì</span> Check</button>
          <button class="game-btn btn-retry" id="retryBtn" onclick="retry()" style="display:none;"><span class="btn-icon">‚Üª</span> Retry</button>
          <button class="game-btn btn-answers" id="answersBtn" onclick="toggleAnswers()" style="display:none;"><span class="btn-icon">üëÅ</span> Answers</button>
          <button class="game-btn btn-new" onclick="newGame()"><span class="btn-icon">‚ü≥</span> New</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentData = null, currentSample = null;
    let sentences = [], paragraphMap = {}, isFirstInParagraph = {}, fixedPositions = {};
    let movableSentences = [], userPositions = {};
    let hasSubmitted = false, showingAnswers = false, totalSentences = 0;

    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('type') || 'essays';
    const isInSubfolder = window.location.pathname.includes('/skills/writing/');
    const dataPrefix = isInSubfolder ? '../../../' : '';
    const DATA_PATHS = {
      essays: `${dataPrefix}data/essays-models.json`,
      reports: `${dataPrefix}data/reports-models.json`,
      reviews: `${dataPrefix}data/reviews-models.json`,
      emails: `${dataPrefix}data/emails-models.json`
    };

    const LINKING_WORDS = [
      'however','therefore','moreover','furthermore','additionally','consequently',
      'meanwhile','nevertheless','nonetheless','thus','hence','accordingly',
      'besides','likewise','similarly','conversely','alternatively','specifically',
      'indeed','subsequently','finally','firstly','secondly','thirdly','lastly',
      'in addition','in contrast','for example','for instance','as a result',
      'on the other hand','in conclusion','to sum up','in summary','in brief',
      'in short','overall','essentially','basically','what is more',
      'to begin with','to start with','by far','it is generally agreed',
      'it was generally felt','one positive aspect','one major concern',
      'this is because','this is mainly due to','as a consequence','what makes','what made'
    ];

    function goBack() { window.location.href = 'index.html'; }
    window.addEventListener('DOMContentLoaded', () => startGame(contentType));

    async function startGame(type) {
      try {
        const response = await fetch(DATA_PATHS[type]);
        if (!response.ok) throw new Error(`Failed to load ${type}`);
        currentData = await response.json();
        currentSample = currentData.samples[Math.floor(Math.random() * currentData.samples.length)];
        extractSentences();
        document.getElementById('gameTitle').textContent = currentSample.topic || 'Sentence Sequencing Challenge';
        renderGame();
      } catch (e) { console.error(e); alert('Failed to load game data.'); }
    }

    function extractSentences() {
      sentences = []; paragraphMap = {}; isFirstInParagraph = {}; fixedPositions = {};
      let idx = 0;
      currentSample.paragraphs.forEach(para => {
        const ps = para.text.split(/(?<=[.!?])\s+/).filter(s => s.trim()).map(s => s.trim());
        ps.forEach((s, i) => {
          paragraphMap[idx] = para.label;
          isFirstInParagraph[idx] = (i === 0);
          if (i === 0) fixedPositions[idx] = idx + 1;
          idx++;
        });
        sentences.push(...ps);
      });
      totalSentences = sentences.length;

      const movableIndices = [];
      sentences.forEach((_, i) => { if (!isFirstInParagraph[i]) movableIndices.push(i); });
      shuffleArray(movableIndices);
      movableSentences = movableIndices.map(i => ({ text: sentences[i], originalIndex: i, correctPosition: i + 1 }));
    }

    function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }

    function highlightLinkingWords(text) {
      let r = text;
      LINKING_WORDS.forEach(w => { r = r.replace(new RegExp(`\\b(${w})\\b`, 'gi'), '<span class="linking-word">$1</span>'); });
      return r;
    }

    function renderGame() {
      hasSubmitted = false; userPositions = {};
      document.getElementById('resultsDisplay').classList.remove('show');
      document.getElementById('submitBtn').style.display = 'inline-flex';
      document.getElementById('retryBtn').style.display = 'none';
      renderSentences();
    }

    function renderSentences() {
      const grid = document.getElementById('sentencesGrid');
      grid.innerHTML = '';

      // 1. Fixed anchors (in correct order)
      Object.keys(fixedPositions).map(Number).sort((a,b) => a - b).forEach(origIdx => {
        const card = document.createElement('div');
        card.className = 'sentence-card fixed-sentence';
        card.id = `card-fixed-${origIdx}`;
        card.innerHTML = `
          <div class="sentence-label">S${origIdx + 1}</div>
          <div class="sentence-content">
            <div class="sentence-text-display">${highlightLinkingWords(sentences[origIdx])}</div>
            <div class="fixed-badge">
              <svg viewBox="0 0 16 16"><path d="M11.5 1a3.5 3.5 0 0 0-3.5 3.5V7H4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2H9.5V4.5a2 2 0 1 1 4 0V6h1.5V4.5A3.5 3.5 0 0 0 11.5 1z"/></svg>
              <span>#${origIdx + 1}</span>
            </div>
          </div>`;
        grid.appendChild(card);
      });

      // 2. Movable: positioned first (sorted), then unpositioned
      const display = movableSentences.map((item, i) => ({ ...item, si: i, up: userPositions[i] ?? null }));
      const positioned = display.filter(m => m.up !== null).sort((a, b) => a.up - b.up);
      const unpositioned = display.filter(m => m.up === null);

      const posCounts = {};
      positioned.forEach(o => { posCounts[o.up] = (posCounts[o.up] || 0) + 1; });
      const fixedSet = new Set(Object.values(fixedPositions));

      [...positioned, ...unpositioned].forEach(item => {
        const card = document.createElement('div');
        card.className = 'sentence-card';
        card.id = `card-movable-${item.si}`;
        if (item.up !== null) {
          card.classList.add('has-number');
          if (posCounts[item.up] > 1 || fixedSet.has(item.up)) card.classList.add('duplicate-number');
        }
        card.innerHTML = `
          <div class="sentence-label">S${item.originalIndex + 1}</div>
          <div class="sentence-content">
            <div class="sentence-text-display">${highlightLinkingWords(item.text)}</div>
            <div class="sentence-input">
              <label>Order</label>
              <input type="number" id="input-${item.si}" min="1" max="${totalSentences}"
                     value="${item.up || ''}" placeholder="#"
                     onblur="updatePosition(${item.si})"
                     onkeypress="if(event.key==='Enter')this.blur()">
            </div>
          </div>`;
        grid.appendChild(card);
      });

      requestAnimationFrame(() => {
        grid.querySelectorAll('.sentence-card').forEach(c => {
          const t = c.querySelector('.sentence-text-display');
          if (t && Math.round(t.offsetHeight / parseFloat(getComputedStyle(t).lineHeight)) > 1) c.classList.add('multi-line');
        });
      });
    }

    function updatePosition(si) {
      const v = parseInt(document.getElementById(`input-${si}`).value);
      if (v >= 1 && v <= totalSentences) { userPositions[si] = v; renderSentences(); }
      else if (document.getElementById(`input-${si}`).value === '') { delete userPositions[si]; renderSentences(); }
    }

    function checkAnswer() {
      if (hasSubmitted) return;
      let allFilled = true;
      const answers = movableSentences.map((item, si) => {
        const p = userPositions[si];
        if (!p || p < 1 || p > totalSentences) allFilled = false;
        return { si, userPos: p || 0, originalIndex: item.originalIndex, correctPosition: item.correctPosition };
      });
      if (!allFilled) { alert('Please fill in all order numbers (1 to ' + totalSentences + ').'); return; }

      const all = [...answers.map(a => a.userPos), ...Object.values(fixedPositions)];
      if (new Set(all).size !== all.length) {
        const seen = new Set(), dupes = new Set();
        all.forEach(p => { if (seen.has(p)) dupes.add(p); seen.add(p); });
        const fd = [...dupes].filter(d => Object.values(fixedPositions).includes(d));
        alert(fd.length ? `Position(s) ${fd.join(', ')} are taken by fixed sentences.` : 'Each number can only be used once!');
        return;
      }

      hasSubmitted = true;
      let cc = 0; const cm = new Set();
      answers.forEach(a => { if (a.userPos === a.correctPosition) { cc++; cm.add(a.si); } });
      answers.forEach(a => {
        const c = document.getElementById(`card-movable-${a.si}`);
        if (c) { c.classList.toggle('correct', cm.has(a.si)); c.classList.toggle('incorrect', !cm.has(a.si)); }
      });
      Object.keys(fixedPositions).forEach(i => { const c = document.getElementById(`card-fixed-${i}`); if (c) c.classList.add('correct'); });

      const fc = Object.keys(fixedPositions).length;
      showResults(Math.round(((cc + fc) / totalSentences) * 100), cc + fc);
    }

    function showResults(pct, correct) {
      const s = document.getElementById('resultsScore'), m = document.getElementById('resultsMessage');
      s.textContent = `${pct}%`;
      if (pct === 100) { s.className = 'results-score perfect-score'; m.textContent = 'üéâ Perfect! You mastered this text structure!'; }
      else if (pct >= 80) { s.className = 'results-score'; m.textContent = `Great job! ${correct} out of ${totalSentences} correct!`; }
      else if (pct >= 60) { s.className = 'results-score'; m.textContent = `Good effort! ${correct} out of ${totalSentences} correct. Try again!`; }
      else { s.className = 'results-score'; m.textContent = `${correct} out of ${totalSentences} correct. Keep practising!`; }
      document.getElementById('resultsDisplay').classList.add('show');
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('retryBtn').style.display = 'inline-flex';
      document.getElementById('answersBtn').style.display = 'inline-flex';
    }

    function retry() {
      hasSubmitted = false; userPositions = {}; showingAnswers = false;
      document.getElementById('answersBtn').innerHTML = '<span class="btn-icon">üëÅ</span> Answers';
      document.getElementById('answersBtn').classList.remove('showing-answers');
      document.getElementById('answersBtn').style.display = 'none';
      document.getElementById('answerKeyDisplay').classList.remove('show');
      shuffleArray(movableSentences); renderSentences();
      document.getElementById('resultsDisplay').classList.remove('show');
      document.getElementById('submitBtn').style.display = 'inline-flex';
      document.getElementById('retryBtn').style.display = 'none';
    }

    function toggleAnswers() {
      const btn = document.getElementById('answersBtn'), disp = document.getElementById('answerKeyDisplay'), cont = document.getElementById('answerKeyContent');
      if (showingAnswers) {
        showingAnswers = false; btn.innerHTML = '<span class="btn-icon">üëÅ</span> Answers';
        btn.classList.remove('showing-answers'); disp.classList.remove('show');
      } else {
        showingAnswers = true; btn.innerHTML = '<span class="btn-icon">‚úï</span> Hide';
        btn.classList.add('showing-answers'); cont.innerHTML = '';
        sentences.forEach((s, i) => {
          const d = document.createElement('div');
          d.className = `answer-sentence${isFirstInParagraph[i] ? ' answer-fixed' : ''}`;
          d.innerHTML = `<div class="answer-number">${i + 1}</div><div class="answer-text">${highlightLinkingWords(s)}</div>`;
          cont.appendChild(d);
        });
        disp.classList.add('show');
      }
    }

    function newGame() {
      showingAnswers = false;
      document.getElementById('answersBtn').innerHTML = '<span class="btn-icon">üëÅ</span> Answers';
      document.getElementById('answersBtn').classList.remove('showing-answers');
      document.getElementById('answersBtn').style.display = 'none';
      document.getElementById('answerKeyDisplay').classList.remove('show');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
